<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-16" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description"
    content="KMRL Dataset Portal - Manage & Explore Kochi Metro Rail Limited documents & datasets with AI-powered assistance." />
  <meta name="keywords" content="KMRL, dataset, AI, document management, Kochi Metro Rail" />
  <meta name="author" content="KMRL Hackathon Team" />
  <meta name="theme-color" content="#3b82f6" />
  <title>KMRL Dataset Portal - AI-Powered Document Management</title>

  <!-- Tailwind CSS v3 CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font for icons and smooth animations -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />
  <!-- Animate.css CDN for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    /* CSS Variables for enhanced theming */
    :root {
      --primary-bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --secondary-bg: rgba(255, 255, 255, 0.05);
      --accent-color: #00d4ff;
      --accent-secondary: #ff6b35;
      --text-primary: #ffffff;
      --text-secondary: #b3c5ef;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --shadow-glow: 0 8px 32px rgba(0, 212, 255, 0.3);
      --train-blue: #0066cc;
      --rail-steel: #c0c0c0;
    }

    [data-theme="light"] {
      --primary-bg: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
      --secondary-bg: rgba(0, 0, 0, 0.03);
      --accent-color: #0066cc;
      --accent-secondary: #dc2626;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(0, 0, 0, 0.1);
      --shadow-glow: 0 8px 32px rgba(0, 102, 204, 0.2);
    }

    /* Base styles with enhanced animations */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--primary-bg);
      min-height: 100vh;
      color: var(--text-primary);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-x: hidden;
      cursor: auto; /* use system cursor (arrow) */
    }

    /* Animated railway-themed background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(90deg, transparent 0%, rgba(0, 212, 255, 0.03) 50%, transparent 100%),
        radial-gradient(circle at 20% 80%, rgba(0, 102, 204, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.05) 0%, transparent 50%),
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 100px,
          rgba(192, 192, 192, 0.02) 101px,
          rgba(192, 192, 192, 0.02) 102px
        );
      animation: railwayFlow 30s linear infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes railwayFlow {
      0% { transform: translateX(-20px) translateY(-10px); }
      50% { transform: translateX(10px) translateY(5px); }
      100% { transform: translateX(-20px) translateY(-10px); }
    }

    /* Enhanced glass card with railway aesthetics */
    .glass-card {
      background: var(--glass-bg);
      border-radius: 24px;
      box-shadow: 
        var(--shadow-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 1px var(--glass-border);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      padding: 2rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass-card:hover::before {
      left: 100%;
    }

    .glass-card:hover {
      transform: translateY(-12px) scale(1.03);
      box-shadow: 
        0 25px 80px rgba(0, 212, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 0 1px rgba(0, 212, 255, 0.3);
    }

    /* Railway-themed premium button */
    .railway-btn {
      position: relative;
      background: linear-gradient(135deg, var(--train-blue), var(--accent-color));
      border-radius: 16px;
      color: white;
      font-weight: 600;
      padding: 1.2rem 2.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 
        0 8px 24px rgba(0, 102, 204, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .railway-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .railway-btn:hover::before {
      opacity: 1;
    }

    .railway-btn:hover {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 
        0 20px 50px rgba(0, 102, 204, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .railway-btn:active {
      transform: translateY(-3px) scale(1.02);
    }

    /* Use system cursor. keep pointer for actionable controls */
    a, button { cursor: pointer; }
    input, textarea { cursor: text; }
    select { cursor: auto; }

    /* Enhanced navbar with train styling */
    .navbar {
      background: rgba(15, 15, 35, 0.9);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 2px solid rgba(0, 102, 204, 0.3);
      position: relative;
    }

    .navbar::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--train-blue), transparent);
      animation: trainTrack 3s ease-in-out infinite;
    }

    @keyframes trainTrack {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }

    .navbar.scrolled {
      background: rgba(15, 15, 35, 0.95);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 1px 0 rgba(0, 102, 204, 0.5);
    }

    /* Text effects */
    .gradient-text {
      background: linear-gradient(270deg, var(--accent-color), var(--train-blue), #8b5cf6);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 4s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Railway track divider */
    .track-divider {
      width: 100%;
      height: 4px;
      background: 
        repeating-linear-gradient(
          90deg,
          var(--rail-steel) 0px,
          var(--rail-steel) 20px,
          transparent 20px,
          transparent 40px
        );
      position: relative;
      margin: 3rem 0;
    }

    .track-divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--train-blue), transparent);
      transform: translateY(-50%);
    }

    /* Enhanced input fields with train styling */
    .premium-input {
      width: 100%;
      padding: 1.2rem 1.8rem;
      border-radius: 16px;
      border: 2px solid transparent;
      background: var(--glass-bg);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      position: relative;
    }

    .premium-input:focus {
      outline: none;
      border-color: var(--train-blue);
      background: rgba(0, 102, 204, 0.05);
      box-shadow: 
        0 0 20px rgba(0, 102, 204, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    /* Progress indicators with train theme */
    .progress-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .progress-track {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--train-blue), var(--accent-color));
      border-radius: 10px;
      width: 0%;
      animation: progressLoad 2s ease-out forwards;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 20px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
      animation: progressGlow 1s ease-in-out infinite alternate;
    }

    @keyframes progressLoad {
      to { width: 85%; }
    }

    @keyframes progressGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Enhanced image hover effects */
    .railway-image {
      position: relative;
      overflow: hidden;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .railway-image img {
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .railway-image:hover img {
      transform: scale(1.15);
    }

    .railway-image::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(
        45deg, 
        rgba(0, 102, 204, 0.1), 
        rgba(0, 212, 255, 0.1),
        rgba(255, 107, 53, 0.05)
      );
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .railway-image:hover::after {
      opacity: 1;
    }

    /* Stats counter with train elements */
    .stat-card {
      position: relative;
      text-align: center;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: linear-gradient(90deg, var(--train-blue), var(--accent-color));
      border-radius: 2px;
    }

    .counter {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--accent-color);
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    }

    /* Loading animation with train theme */
    .train-loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .train-car {
      width: 12px;
      height: 8px;
      background: var(--train-blue);
      border-radius: 2px;
      animation: trainMove 1.5s ease-in-out infinite;
    }

    .train-car:nth-child(1) { animation-delay: 0s; }
    .train-car:nth-child(2) { animation-delay: 0.2s; }
    .train-car:nth-child(3) { animation-delay: 0.4s; }

    @keyframes trainMove {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* Enhanced tooltip */
    .tooltip {
      position: relative;
    }

    .tooltip::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 130%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 15, 35, 0.95);
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 0.875rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      border: 1px solid var(--train-blue);
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.3);
    }

    .tooltip::after {
      content: '';
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--train-blue);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tooltip:hover::before,
    .tooltip:hover::after {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    /* Scroll progress with train track */
    .scroll-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(192, 192, 192, 0.2);
      z-index: 1000;
    }

    .scroll-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--train-blue), var(--accent-color));
      width: 0%;
      transition: width 0.1s ease;
      position: relative;
    }

    .scroll-progress::after {
      content: 'üöÇ';
      position: absolute;
      right: -15px;
      top: -8px;
      font-size: 16px;
      animation: trainBounce 1s ease-in-out infinite;
    }

    @keyframes trainBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    /* Enhanced chatbot with railway theme */
    #chatbot-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 400px;
      max-width: 90vw;
      background: var(--glass-bg);
      border-radius: 24px;
      backdrop-filter: blur(20px) saturate(180%);
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 1px rgba(0, 102, 204, 0.3);
      overflow: hidden;
      z-index: 1100;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-top: 3px solid var(--train-blue);
    }

    #chatbot-container.minimized {
      transform: translateY(calc(100% - 70px));
    }

    #chatbot-header {
      background: linear-gradient(135deg, var(--train-blue), var(--accent-color));
      padding: 1rem 1.5rem;
      color: white;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    #chatbot-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: repeating-linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.3) 0px,
        rgba(255, 255, 255, 0.3) 10px,
        transparent 10px,
        transparent 20px
      );
    }

    /* Theme toggle with train design */
    .theme-toggle {
      position: relative;
      width: 70px;
      height: 34px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(0, 102, 204, 0.3);
    }

    .theme-toggle::before {
      content: 'üåô';
      position: absolute;
      top: 4px;
      left: 6px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--train-blue), var(--accent-color));
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle.active::before {
      content: '‚òÄÔ∏è';
      transform: translateX(36px);
    }

    /* Responsive utilities */
    @media (max-width: 768px) {
      .glass-card {
        padding: 1.5rem;
        border-radius: 16px;
      }
      
      .railway-btn {
        padding: 1rem 2rem;
        font-size: 0.8rem;
      }
      
      .counter {
        font-size: 2rem;
      }

      #chatbot-container {
        width: calc(100vw - 2rem);
        bottom: 1rem;
        right: 1rem;
      }
    }

    /* Animation utilities */
    .slide-up {
      animation: slideUp 0.8s ease-out forwards;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-delayed {
      animation: fadeInDelayed 1s ease-out 0.5s both;
    }

    @keyframes fadeInDelayed {
      from { 
        opacity: 0; 
        transform: translateY(30px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    /* Staggered grid animation */
    .stagger-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
    }

    .stagger-grid > * {
      opacity: 0;
      transform: translateY(50px);
      animation: staggerIn 0.6s ease forwards;
    }

    .stagger-grid > *:nth-child(1) { animation-delay: 0.1s; }
    .stagger-grid > *:nth-child(2) { animation-delay: 0.2s; }
    .stagger-grid > *:nth-child(3) { animation-delay: 0.3s; }
    .stagger-grid > *:nth-child(4) { animation-delay: 0.4s; }
    .stagger-grid > *:nth-child(5) { animation-delay: 0.5s; }
    .stagger-grid > *:nth-child(6) { animation-delay: 0.6s; }

    @keyframes staggerIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Floating animation */
    .floating {
      animation: floating 6s ease-in-out infinite;
    }

    @keyframes floating {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    /* Custom scrollbar with train theme */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--train-blue), var(--accent-color));
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #0052a3, #00b8e6);
      background-clip: content-box;
    }

    /* Enhanced form styling */
    .form-group {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .form-group label {
      position: absolute;
      top: 1.2rem;
      left: 1.8rem;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      pointer-events: none;
      font-size: 1rem;
    }

    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label {
      top: -8px;
      left: 12px;
      font-size: 0.75rem;
      color: var(--train-blue);
      background: var(--glass-bg);
      padding: 0 8px;
      border-radius: 4px;
    }

    /* Mega menu enhancement */
    .mega-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      width: 600px;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(0, 102, 204, 0.2);
      border-radius: 16px;
      padding: 2rem;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      gap: 2rem;
      color: var(--text-secondary);
      z-index: 1000;
      border-top: 3px solid var(--train-blue);
    }

    .menu-item:hover > .mega-dropdown {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(5px);
    }
  </style>

  <!-- Full-page Authentication UI -->
  <style>
    #authPage {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0b1220 0%, #1a1a2e 50%, #16213e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
    }

    #authCard {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 
        0 20px 80px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      color: var(--text-primary);
      border: 1px solid rgba(0, 102, 204, 0.3);
      border-top: 4px solid var(--train-blue);
    }

    #authLeft {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1rem;
    }

    #authRight {
      padding: 2rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .auth-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-color);
      margin-bottom: 0.5rem;
    }

    .auth-sub {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .auth-input {
      width: 100%;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      margin-bottom: 1rem;
      outline: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1rem;
    }

    .auth-input:focus {
      box-shadow: 0 0 20px rgba(0, 102, 204, 0.3);
      transform: translateY(-2px);
      border-color: var(--train-blue);
    }

    .auth-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      background: linear-gradient(135deg, var(--train-blue), var(--accent-color));
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.3);
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 102, 204, 0.5);
    }

    .auth-switch {
      background: transparent;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }

    .auth-switch:hover {
      color: var(--text-primary);
    }

    .role-select {
      width: 100%;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      margin-bottom: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .role-select:focus {
      border-color: var(--train-blue);
      box-shadow: 0 0 20px rgba(0, 102, 204, 0.3);
    }

    .muted {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-message {
      margin-top: 1rem;
      font-size: 0.9rem;
      display: none;
    }

    .auth-message.error {
      color: #f87171;
    }

    .auth-message.success {
      color: #34d399;
    }

    body.app-locked > *:not(#authPage) {
      filter: blur(3px) saturate(0.8);
      pointer-events: none;
      user-select: none;
    }

    @media (max-width: 900px) {
      #authCard {
        grid-template-columns: 1fr;
        max-width: 500px;
      }
    }
  </style>
</head>

<body data-theme="dark">
  <!-- Scroll progress indicator -->
  <div class="scroll-indicator">
    <div class="scroll-progress" id="scrollProgress"></div>
  </div>

  <!-- Authentication Page -->
  <div id="authPage">
    <div id="authCard">
      <div id="authLeft">
        <h1 class="auth-title">üöÜ Welcome to KMRL</h1>
        <p class="auth-sub">Smart Document Management System</p>
        <p class="muted">Join Kochi Metro Rail Limited's AI-powered document portal. Streamline your workflow with intelligent document processing and management.</p>
        
        <div class="railway-image" style="margin: 2rem 0;">
          <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&w=800&q=80" 
               alt="Kochi Metro Station" 
               style="height: 200px; border-radius: 12px;" />
        </div>
        
        <div class="track-divider"></div>
        
        <div class="progress-container">
          <span class="muted">System Status:</span>
          <div class="progress-track">
            <div class="progress-fill"></div>
          </div>
          <span style="color: var(--accent-color); font-weight: 600;">85%</span>
        </div>
      </div>

      <div id="authRight">
        <div id="loginForm">
          <h2 class="auth-title" style="font-size: 1.5rem;">Login</h2>
          <p class="auth-sub">Access your KMRL account</p>
          
          <form class="space-y-4">
            <div class="form-group">
              <input type="text" id="loginUsername" name="username" class="auth-input" placeholder=" " autocomplete="username" required />
              <label>Username or Email</label>
            </div>
            
            <div class="form-group">
              <input type="password" id="loginPassword" name="password" class="auth-input" placeholder=" " autocomplete="current-password" required />
              <label>Password</label>
            </div>
            
            <div class="flex items-center justify-between mb-4">
              <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="checkbox" class="rounded border-gray-600 bg-gray-700" />
                Remember me
              </label>
              <button type="button" class="auth-switch">Forgot password?</button>
            </div>
            
            <button type="button" class="auth-btn w-full" id="loginButton">
              <div class="train-loading hidden" id="loginLoading">
                <div class="train-car"></div>
                <div class="train-car"></div>
                <div class="train-car"></div>
              </div>
              <span id="loginText">Login to Portal</span>
            </button>
          </form>
          
          <p id="loginError" class="auth-message error"></p>
          
          <div class="text-center mt-6">
            <span class="muted">Don't have an account? </span>
            <button class="auth-switch" id="showSignup">Create Account</button>
          </div>
        </div>

        <div id="signupForm" style="display: none;">
          <h2 class="auth-title" style="font-size: 1.5rem;">Create Account</h2>
          <p class="auth-sub">Join the KMRL digital ecosystem</p>
          
          <form class="space-y-4">
            <div class="form-group">
              <input type="text" id="signupFullName" name="full_name" class="auth-input" placeholder=" " autocomplete="name" required />
              <label>Full Name</label>
            </div>
            
            <div class="form-group">
              <input type="email" id="signupEmail" name="email" class="auth-input" placeholder=" " autocomplete="email" required />
              <label>Email Address</label>
            </div>
            
            <div class="form-group">
              <input type="password" id="signupPassword" name="password" class="auth-input" placeholder=" " autocomplete="new-password" required />
              <label>Password</label>
            </div>
            
            <select id="signupRole" name="role" class="role-select" required>
              <option value="">Select Your Role</option>
              <option value="viewer">Viewer - View documents only</option>
              <option value="contributor">Contributor - Upload & manage</option>
              <option value="admin">Admin - Full system access</option>
            </select>
            
            <button type="button" class="auth-btn w-full" id="signupButton">
              <div class="train-loading hidden" id="signupLoading">
                <div class="train-car"></div>
                <div class="train-car"></div>
                <div class="train-car"></div>
              </div>
              <span id="signupText">Create Account</span>
            </button>
          </form>
          
          <p id="signupFeedback" class="auth-message"></p>
          
          <div class="text-center mt-6">
            <span class="muted">Already have an account? </span>
            <button class="auth-switch" id="showLogin">Sign In</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Navbar -->
  <nav id="navbar" class="navbar fixed top-0 left-0 right-0 z-50 transition-all duration-500">
    <div class="max-w-7xl mx-auto px-6 flex justify-between items-center h-20">
      <a href="#welcome-section" class="text-white font-bold text-2xl gradient-text">
        üöÜ KMRL Dataset Portal
      </a>
      
      <div class="hidden md:flex items-center space-x-8">
        <div class="menu-item">
          <a href="#welcome-section" class="text-white/80 hover:text-white transition-colors tooltip magnetic" data-tooltip="Dashboard">
            üè† Home
          </a>
          <div class="mega-dropdown">
            <div>
              <h4 style="color: var(--accent-color); font-weight: 700; margin-bottom: 1rem;">Getting Started</h4>
              <p>Welcome to KMRL's intelligent document management system.</p>
              <div class="railway-image" style="margin-top: 1rem;">
                <img src="https://images.unsplash.com/photo-1581833971358-2c8b550f87b3?auto=format&fit=crop&w=400&q=80" 
                     alt="Metro Control Room" style="height: 120px;" />
              </div>
            </div>
            <div>
              <h4 style="color: var(--accent-color); font-weight: 700; margin-bottom: 1rem;">Quick Access</h4>
              <ul class="space-y-2">
                <li><a href="#view-datasets" class="text-blue-400 hover:underline">üìä View Datasets</a></li>
                <li><a href="#contribute" class="text-blue-400 hover:underline">‚ûï Upload Documents</a></li>
                <li><a href="#about" class="text-blue-400 hover:underline">‚ÑπÔ∏è System Info</a></li>
              </ul>
            </div>
          </div>
        </div>
        <a href="#view-datasets" class="text-white/80 hover:text-white transition-colors tooltip magnetic" data-tooltip="Browse Data">üìä Datasets</a>
        <a href="#contribute" class="text-white/80 hover:text-white transition-colors tooltip magnetic" data-tooltip="Upload Files">‚ûï Contribute</a>
        <a href="#about" class="text-white/80 hover:text-white transition-colors tooltip magnetic" data-tooltip="Information">‚ÑπÔ∏è About</a>
      </div>

      <div class="flex items-center space-x-4">
        <div class="theme-toggle" id="themeToggle"></div>
        <span id="userWelcome" class="hidden text-white font-semibold">Welcome, <span id="currentUser">User</span></span>
        <button id="logoutBtn" class="railway-btn hidden" style="background:transparent; color:white; border:1px solid rgba(255,255,255,0.08); padding:0.5rem 1rem; font-weight:600;">
          Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section id="welcome-section" class="min-h-screen flex items-center justify-center px-6 py-20">
    <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 items-center">
      <div class="slide-up">
        <h1 class="text-6xl lg:text-7xl font-black mb-6 leading-tight">
          Welcome to <span class="gradient-text">Metrodocs</span> AI
        </h1>
        <p class="text-xl lg:text-2xl text-gray-300 mb-4">
         Role:  <span id="userRole" class="font-bold" style="color: var(--accent-color);">System User</span>
        </p>
        <p class="text-lg lg:text-xl mb-8 leading-relaxed" style="color: var(--text-secondary);">
          "Using AI to improve document handling, automate processes, and enable better collaboration at KMRL"
        </p>
        
        <div class="flex flex-col sm:flex-row gap-4 mb-12">
          <button class="railway-btn floating magnetic" id="exploreBtn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            Explore Datasets
          </button>
          <button class="railway-btn" style="background: linear-gradient(135deg, #8b5cf6, #06b6d4);" id="btnStartChat">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Chat with AI
          </button>
        </div>
        
        <!-- Enhanced Stats Section -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 fade-in-delayed">
          <div class="stat-card glass-card p-6 text-center">
            <div class="counter" id="counter1">0</div>
            <p class="text-sm" style="color: var(--text-secondary);">Documents Processed</p>
          </div>
          <div class="stat-card glass-card p-6 text-center">
            <div class="counter" id="counter2">0</div>
            <p class="text-sm" style="color: var(--text-secondary);">Hours Saved Daily</p>
          </div>
          <div class="stat-card glass-card p-6 text-center">
            <div class="counter" id="counter3">0</div>
            <p class="text-sm" style="color: var(--text-secondary);">Active Departments</p>
          </div>
          <div class="stat-card glass-card p-6 text-center">
            <div class="counter" id="counter4">0</div>
            <p class="text-sm" style="color: var(--text-secondary);">%</p>
            <p class="text-sm" style="color: var(--text-secondary);">Accuracy Rate</p>
          </div>
        </div>
      </div>

      <div class="railway-image slide-up floating">
  <img src="assets/train2.jpg" 
             alt="Modern Kochi Metro Train" 
             class="w-full h-[500px] lg:h-[600px] object-cover rounded-3xl shadow-2xl" />
      </div>
    </div>
  </section>

  <!-- Track Divider -->
  <div class="track-divider"></div>

  <!-- Search & Filter Section -->
  <section class="max-w-6xl mx-auto px-6 py-16">
    <div class="glass-card">
      <h2 class="text-3xl font-bold text-center mb-8 gradient-text">Search & Discover</h2>
      <div class="relative max-w-3xl mx-auto mb-8">
        <input 
          type="search" 
          placeholder="Search datasets, documents, or ask AI..." 
          class="premium-input text-lg pl-16 pr-16"
          id="searchInput"
        />
        <svg class="absolute left-5 top-1/2 transform -translate-y-1/2 w-6 h-6" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <div class="absolute right-5 top-1/2 transform -translate-y-1/2">
          <div class="train-loading hidden" id="searchLoading">
            <div class="train-car"></div>
            <div class="train-car"></div>
            <div class="train-car"></div>
          </div>
        </div>
        <div id="search-suggestions" style="display: none;"></div>
      </div>
      
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <label for="sortSelect" style="color: var(--text-secondary);">Sort by:</label>
        <select id="sortSelect" class="premium-input max-w-xs">
          <option value="name-asc">Name: A ‚Üí Z</option>
          <option value="name-desc">Name: Z ‚Üí A</option>
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="uploader-asc">Uploader: A ‚Üí Z</option>
          <option value="uploader-desc">Uploader: Z ‚Üí A</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Datasets Grid -->
  <section id="view-datasets" class="max-w-7xl mx-auto px-6 py-20">
    <h2 class="text-4xl font-bold text-center mb-16 gradient-text">üìä Railway Datasets</h2>
    <div class="stagger-grid" id="datasetContainer">
      <!-- Datasets will be populated by JavaScript -->
    </div>
  </section>

  <!-- Track Divider -->
  <div class="track-divider"></div>

  <!-- Contribute Section -->
  <section id="contribute" class="max-w-4xl mx-auto px-6 py-20">
    <div class="glass-card">
      <h2 class="text-4xl font-bold text-center mb-8 gradient-text">‚ûï Contribute Dataset</h2>
      <p class="text-center mb-12" style="color: var(--text-secondary);">
        Upload and share your railway documents to enhance our AI-powered system
      </p>
      
      <form id="contributeForm" class="space-y-6">
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="form-group">
            <input type="text" class="premium-input" placeholder=" " required id="datasetName" />
            <label>Dataset Name</label>
          </div>
          <div class="form-group">
            <input type="text" class="premium-input" placeholder=" " required />
            <label>Department</label>
          </div>
        </div>
        
        <div class="form-group">
          <textarea class="premium-input" placeholder=" " rows="4" required id="datasetDesc"></textarea>
          <label>Dataset Description</label>
        </div>
        
        <div class="form-group">
          <input type="file" class="premium-input" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" required id="datasetFile" />
        </div>
        
        <button type="submit" class="railway-btn w-full justify-center text-lg">
          <div class="train-loading hidden" id="submitLoading">
            <div class="train-car"></div>
            <div class="train-car"></div>
            <div class="train-car"></div>
          </div>
          <span id="submitText">Submit Dataset</span>
        </button>
        <p id="formMsg" class="text-center text-red-400 hidden"></p>
      </form>
    </div>
  </section>

  <!-- Dashboard Charts Section -->
  <section id="dashboardCharts" class="max-w-6xl mx-auto px-6 py-20">
    <h2 class="text-4xl font-bold text-center mb-16 gradient-text">üìà System Analytics</h2>
    <div class="glass-card p-8">
      <canvas id="datasetsChart" class="w-full h-96"></canvas>
    </div>
  </section>

  <!-- Track Divider -->
  <div class="track-divider"></div>

  <!-- Testimonials Section -->
   <section id="testimonials" class="max-w-5xl mx-auto px-6 py-20">
    <h2 class="text-4xl font-bold text-center mb-16 gradient-text">What Our Team Says</h2>
    <div id="testimonialSlides" class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1506629082955-511b1aa562c8?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">üí° "Building SmartDoc AI taught us how AI can revolutionize document management and bring real impact to organizations like KMRL."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Nitish Gupta</p>
          </div>
        </div>
      </div>

      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">üìä "Integrating datasets and visual analytics helped us present insights clearly, making data actionable for decision-makers."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Vidhi Jindal</p>
          </div>
        </div>
      </div>

      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">üîç "Working on intelligent search and automation showed me how AI can save hundreds of hours every day in document handling."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Twarit Shukla</p>
          </div>
        </div>
      </div>

      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1506629082955-511b1aa562c8?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">‚ö° "Designing the interface was exciting ‚Äî our goal was to keep it simple, modern, and user-friendly for all KMRL departments."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Palak Khanna</p>
          </div>
        </div>
      </div>

      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">üéØ "Coordinating modules and ensuring smooth integration was challenging, but teamwork made SmartDoc AI possible."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Megha Sharma</p>
          </div>
        </div>
      </div>

      <div class="glass-card p-8 text-left rounded-3xl">
        <div class="flex items-start gap-4">
          <div class="railway-image w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
            <img src="assets/kochimetro_train.jpg" alt="Kochi Metro Train" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=150&q=80'" />
          </div>
          <div>
            <p class="text-lg mb-2" style="color: var(--text-secondary);">üå± "Adding features like sustainability metrics and compliance tracking proved how versatile SmartDoc AI can be."</p>
            <p class="font-semibold" style="color: var(--accent-color);">‚Äî Deepanshi</p>
          </div>
        </div>
      </div>
    </div>
    <!-- Carousel controls removed - grid layout now used -->
    <!-- <div class="flex justify-center space-x-4 mt-8"> carousel controls hidden </div> -->
  </section>

  <!-- About Section -->
  <section id="about" class="max-w-6xl mx-auto px-6 py-20">
  <h2 class="text-4xl font-bold text-center mb-16 gradient-text">‚ÑπÔ∏è About metrodocs ai</h2>
    
    <div class="grid lg:grid-cols-2 gap-12 items-center mb-16">
      <div class="glass-card p-8 space-y-6">
        <h3 class="text-2xl font-bold" style="color: var(--accent-color);">Our Mission</h3>
        <p style="color: var(--text-secondary);">
          At <strong>KMRL Hackathon</strong>, we're revolutionizing document management for Kochi Metro Rail Limited. 
          Our metrodocs ai tackles document overload with intelligent automation and AI-powered insights.
        </p>
        
        <ul class="space-y-3" style="color: var(--text-secondary);">
          <li class="flex items-start gap-3">
            <span style="color: var(--accent-color);">üîÑ</span>
            <span>Automated document ingestion with OCR processing</span>
          </li>
          <li class="flex items-start gap-3">
            <span style="color: var(--accent-color);">üìä</span>
            <span>Smart dashboards with real-time analytics</span>
          </li>
          <li class="flex items-start gap-3">
            <span style="color: var(--accent-color);">‚ö†Ô∏è</span>
            <span>Compliance alerts and deadline management</span>
          </li>
          <li class="flex items-start gap-3">
            <span style="color: var(--accent-color);">ü§ù</span>
            <span>Collaborative knowledge hub for teams</span>
          </li>
          <li class="flex items-start gap-3">
            <span style="color: var(--accent-color);">üå±</span>
            <span>Environmental sustainability through paperless operations</span>
          </li>
        </ul>
      </div>
      
      <div class="railway-image">
        <img src="assets/Down.png" 
             alt="KMRL Operations Center" 
             class="w-full h-[400px] object-cover rounded-3xl shadow-2xl" />
      </div>
    </div>
    
    <div class="glass-card p-8 text-center">
      <h3 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">Our Vision</h3>
      <p class="text-xl mb-6" style="color: var(--text-secondary);">
        Creating a future-ready, paperless, and efficient KMRL ecosystem where documents empower progress, not create roadblocks.
      </p>
      <blockquote class="text-lg italic" style="color: var(--text-primary);">
        "Technology should simplify complexity, not add to it."
      </blockquote>
    </div>
    <!-- KMRL logo appended for About section -->
    <div id="about-logo" style="display:flex;justify-content:center;margin-top:1.5rem;">
      <img id="about-logo-img" src="assets/logo.png" alt="KMRL Logo" style="width:140px;height:auto;object-fit:contain;filter:drop-shadow(0 8px 20px rgba(0,0,0,0.35));" />
    </div>
  </section>

  <!-- Enhanced Chatbot -->
  <div id="chatbot-container">
      <div id="chatbot-header" style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem;">
        <div style="display:flex;align-items:center;gap:0.75rem;">
          <img id="chat-train-img" src="assets/train.png" alt="train" style="width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 3px 10px rgba(0,0,0,0.35);"/>
          <div class="flex items-center gap-2">
            <span>üí¨ KMRL AI Assistant</span>
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" aria-hidden="true"></div>
          </div>
        </div>
        <div style="display:flex; gap:0.5rem;">
          <button id="chatbotSettingsBtn" class="text-xs bg-white/10 px-2 py-1 rounded border border-white/20">Key</button>
          <button id="chatbotToggleBtn" class="text-xs bg-white/20 px-2 py-1 rounded">Hide</button>
        </div>
      </div>
    <div id="chatbot-messages" style="max-height: 300px; overflow-y: auto; padding: 1rem; background: rgba(15, 15, 35, 0.9); color: white;"></div>
    <div style="display: flex; padding: 1rem; background: rgba(30, 41, 59, 0.9); border-top: 1px solid rgba(0, 102, 204, 0.3);">
      <input id="chatbot-input" placeholder="Ask about datasets, processes..." style="flex: 1; background: transparent; border: none; color: white; padding: 0.5rem;" />
      <button id="chatbot-send" class="railway-btn ml-2 py-2 px-4 text-sm">Send</button>
    </div>
  </div>

  <!-- Enhanced JavaScript -->
  <script>
    // === THEME MANAGEMENT ===
    const themeToggle = document.getElementById('themeToggle');
    let isDark = localStorage.getItem('kmrlTheme') !== 'light';

    function resolveApiBase() {
      const queryApi = new URLSearchParams(window.location.search).get('api');
      if (queryApi) {
        return queryApi.replace(/\/$/, '');
      }
      if (window.APP_API_BASE) {
        return String(window.APP_API_BASE).replace(/\/$/, '');
      }
      if (window.location.protocol === 'file:') {
        const stored = localStorage.getItem('kmrlApiBase');
        if (stored) {
          return stored.replace(/\/$/, '');
        }
        const defaultBase = 'http://127.0.0.1:5008';
        localStorage.setItem('kmrlApiBase', defaultBase);
        return defaultBase;
      }
      const origin = window.location.origin.replace(/\/$/, '');
      if (origin.includes('127.0.0.1:5500') || origin.includes('localhost:5500')) {
        return origin.replace('5500', '5008');
      }
      return origin;
    }

    const API_BASE = resolveApiBase();
    if (window.location.protocol === 'file:') {
      localStorage.setItem('kmrlApiBase', API_BASE);
    }

    function applyTheme(dark) {
      document.body.setAttribute('data-theme', dark ? 'dark' : 'light');
      themeToggle.classList.toggle('active', !dark);
      localStorage.setItem('kmrlTheme', dark ? 'dark' : 'light');
    }

    applyTheme(isDark);
    themeToggle.addEventListener('click', () => {
      isDark = !isDark;
      applyTheme(isDark);
    });

    // === AUTHENTICATION SYSTEM ===
    const authPage = document.getElementById('authPage');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showSignupBtn = document.getElementById('showSignup');
    const showLoginBtn = document.getElementById('showLogin');
    const loginButton = document.getElementById('loginButton');
    const signupButton = document.getElementById('signupButton');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginUsernameInput = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');
    const signupFullNameInput = document.getElementById('signupFullName');
    const signupEmailInput = document.getElementById('signupEmail');
    const signupPasswordInput = document.getElementById('signupPassword');
    const signupRoleSelect = document.getElementById('signupRole');
    const loginError = document.getElementById('loginError');
    const signupFeedback = document.getElementById('signupFeedback');

    let isAuthenticated = false;
    let currentUser = 'Guest';
    let userRole = 'Viewer';

    function setAuthMessage(element, message = '', type = 'error') {
      if (!element) return;
      element.textContent = message || '';
      element.classList.remove('error', 'success');
      if (!message) {
        element.style.display = 'none';
        return;
      }
      element.classList.add(type);
      element.style.display = 'block';
    }

    function formatRole(role) {
      if (!role) return 'Viewer';
      return role
        .split(' ')
        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
        .join(' ');
    }

    function showAuth() {
      if (!authPage) return;
      authPage.style.display = 'flex';
      document.body.classList.add('app-locked');
    }

    function hideAuth() {
      if (!authPage) return;
      authPage.style.display = 'none';
      document.body.classList.remove('app-locked');
    }

    function applySession(data) {
      if (data && data.authenticated) {
        isAuthenticated = true;
        currentUser = data.display_name || data.username || 'User';
        userRole = formatRole(data.role || 'Viewer');
      } else {
        isAuthenticated = false;
        currentUser = 'Guest';
        userRole = 'Viewer';
      }
      updateUserDisplay();
    }

    function updateUserDisplay() {
      const userWelcome = document.getElementById('userWelcome');
      const currentUserSpan = document.getElementById('currentUser');
      const userRoleSpan = document.getElementById('userRole');

      if (userRoleSpan) {
        userRoleSpan.textContent = userRole;
      }

      if (isAuthenticated) {
        if (userWelcome) userWelcome.classList.remove('hidden');
        if (currentUserSpan) currentUserSpan.textContent = currentUser;
        if (logoutBtn) logoutBtn.classList.remove('hidden');
        hideAuth();
      } else {
        if (userWelcome) userWelcome.classList.add('hidden');
        if (logoutBtn) logoutBtn.classList.add('hidden');
        if (signupForm) signupForm.style.display = 'none';
        if (loginForm) loginForm.style.display = 'block';
        setAuthMessage(loginError);
        setAuthMessage(signupFeedback);
        showAuth();
      }
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch(`${API_BASE}/api/logout`, { method: 'POST', credentials: 'include' });
        } catch (error) {
          console.error('Logout failed', error);
        }
        applySession(null);
      });
    }

    if (showSignupBtn) {
      showSignupBtn.addEventListener('click', () => {
        if (loginForm) loginForm.style.display = 'none';
        if (signupForm) signupForm.style.display = 'block';
        setAuthMessage(loginError);
        setAuthMessage(signupFeedback);
      });
    }

    if (showLoginBtn) {
      showLoginBtn.addEventListener('click', () => {
        if (signupForm) signupForm.style.display = 'none';
        if (loginForm) loginForm.style.display = 'block';
        setAuthMessage(loginError);
        setAuthMessage(signupFeedback);
      });
    }

    async function handleLogin() {
      const loginLoading = document.getElementById('loginLoading');
      const loginText = document.getElementById('loginText');

      if (!loginUsernameInput || !loginPasswordInput) return;

      setAuthMessage(loginError);
      const usernameValue = loginUsernameInput.value.trim();
      const passwordValue = loginPasswordInput.value;

      if (!usernameValue || !passwordValue) {
        setAuthMessage(loginError, 'Please enter your username or email and password.', 'error');
        return;
      }

      loginLoading.classList.remove('hidden');
      loginText.textContent = 'Authenticating...';
      loginButton.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username: usernameValue, password: passwordValue })
        });

        const data = await response.json();
        if (!response.ok) {
          setAuthMessage(loginError, data.error || 'Unable to login. Please try again.', 'error');
        } else {
          loginUsernameInput.value = '';
          loginPasswordInput.value = '';
          setAuthMessage(loginError);
          applySession(data);
        }
      } catch (error) {
        console.error('Login failed', error);
        setAuthMessage(
          loginError,
          `Unable to reach the server at ${API_BASE}. Please confirm it is running.`,
          'error'
        );
      } finally {
        loginLoading.classList.add('hidden');
        loginText.textContent = 'Login to Portal';
        loginButton.disabled = false;
      }
    }

    if (loginButton) {
      loginButton.addEventListener('click', () => {
        handleLogin();
      });
    }

    async function handleSignup() {
      const signupLoading = document.getElementById('signupLoading');
      const signupText = document.getElementById('signupText');

      if (!signupFullNameInput || !signupEmailInput || !signupPasswordInput || !signupRoleSelect) return;

      setAuthMessage(signupFeedback);
      const fullName = signupFullNameInput.value.trim();
      const email = signupEmailInput.value.trim();
      const password = signupPasswordInput.value;
      const role = signupRoleSelect.value || 'viewer';

      if (!fullName || !email || !password) {
        setAuthMessage(signupFeedback, 'Please complete all fields to create an account.', 'error');
        return;
      }

      signupLoading.classList.remove('hidden');
      signupText.textContent = 'Creating Account...';
      signupButton.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            username: email,
            full_name: fullName,
            email: email,
            password: password,
            role
          })
        });

        const data = await response.json();
        if (!response.ok) {
          setAuthMessage(signupFeedback, data.error || 'Unable to create account. Please try again.', 'error');
        } else {
          signupFullNameInput.value = '';
          signupEmailInput.value = '';
          signupPasswordInput.value = '';
          signupRoleSelect.value = '';
          const successMessage = data.message || 'Account created successfully. Please sign in.';
          setAuthMessage(signupFeedback, successMessage, 'success');
          if (signupForm) signupForm.style.display = 'none';
          if (loginForm) loginForm.style.display = 'block';
          if (loginUsernameInput) {
            loginUsernameInput.value = data.username || email;
            loginUsernameInput.focus();
          }
          setAuthMessage(loginError, successMessage, 'success');
        }
      } catch (error) {
        console.error('Signup failed', error);
        setAuthMessage(
          signupFeedback,
          `Unable to reach the server at ${API_BASE}. Please confirm it is running.`,
          'error'
        );
      } finally {
        signupLoading.classList.add('hidden');
        signupText.textContent = 'Create Account';
        signupButton.disabled = false;
      }
    }

    if (signupButton) {
      signupButton.addEventListener('click', () => {
        handleSignup();
      });
    }

    async function fetchSession() {
      try {
        const response = await fetch(`${API_BASE}/api/session`, { credentials: 'include' });
        const data = await response.json();
        applySession(data);
      } catch (error) {
        console.error('Session check failed', error);
        applySession(null);
      }
    }

    updateUserDisplay();
    fetchSession();

    // === ENHANCED NAVBAR ===
    const navbar = document.getElementById('navbar');
    let lastScrollY = window.pageYOffset;

    window.addEventListener('scroll', () => {
      const currentScrollY = window.pageYOffset;
      
      if (currentScrollY > lastScrollY && currentScrollY > 100) {
        navbar.style.transform = 'translateY(-100%)';
      } else {
        navbar.style.transform = 'translateY(0)';
      }
      
      if (currentScrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
      
      lastScrollY = currentScrollY;
      
      // Update scroll progress
      const scrollProgress = document.getElementById('scrollProgress');
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = (currentScrollY / docHeight) * 100;
      scrollProgress.style.width = scrollPercent + '%';
    });

    // === DATASET MANAGEMENT ===
    const datasets = [
      {
        name: "Engineering Department",
        uploader: "Engineering Department",
        description: "Comprehensive maintenance logs and inspection reports for metro tracks",
        date: "2024-01-15",
        type: "Maintenance",
        image: "https://images.unsplash.com/photo-1563516309923-758bb8b3086a?auto=format&fit=crop&w=400&q=80",
        url: "https://drive.google.com/drive/folders/1aRi_wt-x7cAzWw40Sq3wrtU4YRvsIU1a?usp=drive_link"
      },
      {
        name: "Finance",
        uploader: "Operations Team",
        description: "Detailed analysis of passenger movement patterns and peak hour data",
        date: "2024-01-20",
        type: "Analytics",
        image: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&w=400&q=80",
        url: "https://drive.google.com/drive/folders/16actyxE_2jl4ZCiEe8alEDcmI1r7fLtK"
      },
      {
        name: "Management Department",
        uploader: "Safety Division",
        description: "Updated safety procedures and emergency response guidelines",
        date: "2024-01-10",
        type: "Safety",
        image: "https://images.unsplash.com/photo-1562576242-c78b3c62e7c4?auto=format&fit=crop&w=400&q=80",
        url: "https://drive.google.com/drive/folders/1hwOb8hYoPHqUokU99URGRsfR_CgBMP9u"
      },
      {
        name: "HR (Human Resources)",
        uploader: "Finance Department",
        description: "Monthly revenue analysis and fare collection statistics",
        date: "2024-01-25",
        type: "Finance",
        image: "https://images.unsplash.com/photo-1559526324-593bc073d938?auto=format&fit=crop&w=400&q=80",
        url: "https://drive.google.com/drive/folders/1tzB3iKgrVk6VM5dRKfTu62BN93H7Hvvp"
      },
      {
        name: "Employee Training Records",
        uploader: "HR Division",
        description: "Staff certification and training completion database",
        date: "2024-01-12",
        type: "HR",
        image: "https://images.unsplash.com/photo-1600880292089-90a7e086ee0c?auto=format&fit=crop&w=400&q=80"
      },
      {
        name: "Environmental Impact Assessment",
        uploader: "Environmental Team",
        description: "Carbon footprint analysis and sustainability metrics",
        date: "2024-01-18",
        type: "Environment",
        image: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=400&q=80"
      }
    ];

    let filteredDatasets = [...datasets];

    function renderDatasets(datasetList) {
      const container = document.getElementById('datasetContainer');
      container.innerHTML = '';

      if (!datasetList || datasetList.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-16">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">No datasets found</h3>
            <p style="color: var(--text-secondary);">Try adjusting your search criteria</p>
          </div>
        `;
        return;
      }

      datasetList.forEach((dataset, index) => {
        const card = document.createElement('div');
        card.className = 'glass-card hover-shadow';
        card.style.animationDelay = (index * 0.1) + 's';

        // If dataset has a URL, make the View control an anchor that opens it
        const viewControl = dataset.url
          ? `<a href="${dataset.url}" target="_blank" rel="noopener" class="railway-btn py-2 px-4 text-sm tooltip" data-tooltip="Open in Drive">
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 3h7v7" />
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 3L10 14" />
               </svg>
               Open
             </a>`
          : `<button class="railway-btn py-2 px-4 text-sm tooltip" data-tooltip="View Dataset">
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
               </svg>
               View
             </button>`;

        card.innerHTML = `
          <div class="railway-image mb-4" style="height: 180px;">
            <img src="${dataset.image}" alt="${dataset.name}" class="w-full h-full object-cover rounded-lg" />
          </div>
          <h3 class="text-xl font-semibold mb-2" style="color: var(--accent-color);">${dataset.name}</h3>
          <p class="text-sm mb-2" style="color: var(--text-secondary);">
            <span class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs mr-2">${dataset.type}</span>
            by ${dataset.uploader}
          </p>
          <p class="mb-4" style="color: var(--text-secondary); font-size: 0.9rem;">${dataset.description}</p>
          <div class="flex justify-between items-center">
            <span class="text-xs" style="color: var(--text-secondary);">${new Date(dataset.date).toLocaleDateString()}</span>
            ${viewControl}
          </div>
        `;

        container.appendChild(card);
      });
    }

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('search-suggestions');
    const searchLoading = document.getElementById('searchLoading');

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      
      if (query.length === 0) {
        searchSuggestions.style.display = 'none';
        filteredDatasets = [...datasets];
        renderDatasets(filteredDatasets);
        return;
      }
      
      searchLoading.classList.remove('hidden');
      
      setTimeout(() => {
        filteredDatasets = datasets.filter(dataset =>
          dataset.name.toLowerCase().includes(query) ||
          dataset.uploader.toLowerCase().includes(query) ||
          dataset.description.toLowerCase().includes(query) ||
          dataset.type.toLowerCase().includes(query)
        );
        
        renderDatasets(filteredDatasets);
        searchLoading.classList.add('hidden');
        
        // Show suggestions
        if (filteredDatasets.length > 0 && query.length > 2) {
          showSearchSuggestions(filteredDatasets.slice(0, 3), query);
        } else {
          searchSuggestions.style.display = 'none';
        }
      }, 500);
    });

   function showSearchSuggestions(suggestions, query) {
  searchSuggestions.innerHTML = '';
  suggestions.forEach(dataset => {
    const div = document.createElement('div');
    div.textContent = `${dataset.name} - ${dataset.type}`;
    div.style.padding = '0.75rem 1rem';
    div.style.cursor = 'pointer';
    div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
    div.addEventListener('click', () => {
      searchInput.value = dataset.name;
      searchSuggestions.style.display = 'none';
      filteredDatasets = [dataset];
      renderDatasets(filteredDatasets);
    });
    searchSuggestions.appendChild(div);
  });
  searchSuggestions.style.display = 'block';
}

    // Sort functionality
    document.getElementById('sortSelect').addEventListener('change', (e) => {
      const sortType = e.target.value;
      
      
      switch(sortType) {
        case 'name-asc':
          filteredDatasets.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'name-desc':
          filteredDatasets.sort((a, b) => b.name.localeCompare(a.name));
          break;
        case 'date-desc':
                   filteredDatasets.sort((a, b) => new Date(b.date) - new Date(a.date));
          break;
        case 'date-asc':
          filteredDatasets.sort((a, b) => new Date(a.date) - new Date(b.date));
          break;
        case 'uploader-asc':
          filteredDatasets.sort((a, b) => a.uploader.localeCompare(b.uploader));
          break;
        case 'uploader-desc':
          filteredDatasets.sort((a, b) => b.uploader.localeCompare(a.uploader));
          break;
      }
      
      renderDatasets(filteredDatasets);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
        searchSuggestions.style.display = 'none';
      }
    });

    // Initial render
    renderDatasets(filteredDatasets);

    // === CONTRIBUTE FORM ===
    const contributeForm = document.getElementById('contributeForm');
    const submitLoading = document.getElementById('submitLoading');
    const submitText = document.getElementById('submitText');
    const formMsg = document.getElementById('formMsg');

    contributeForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = document.getElementById('datasetName').value.trim();
      const desc = document.getElementById('datasetDesc').value.trim();
      const file = document.getElementById('datasetFile').files[0];
      
      formMsg.classList.add('hidden');
      
      if (!name || !desc || !file) {
        formMsg.textContent = 'Please fill all fields and select a file.';
        formMsg.classList.remove('hidden');
        formMsg.style.color = '#ef4444';
        return;
      }
      
      submitLoading.classList.remove('hidden');
      submitText.textContent = 'Processing...';
      
      setTimeout(() => {
        // Simulate successful upload
        const newDataset = {
          name: name,
          uploader: currentUser,
          description: desc,
          date: new Date().toISOString().split('T')[0],
          type: 'User Upload',
          image: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&w=400&q=80'
        };
        
        datasets.unshift(newDataset);
        filteredDatasets = [...datasets];
        renderDatasets(filteredDatasets);
        
        contributeForm.reset();
        formMsg.textContent = `Dataset "${name}" uploaded successfully! AI processing initiated.`;
        formMsg.classList.remove('hidden');
        formMsg.style.color = '#10b981';
        
        submitLoading.classList.add('hidden');
        submitText.textContent = 'Submit Dataset';
        
        setTimeout(() => {
          formMsg.classList.add('hidden');
        }, 5000);
      }, 3000);
    });

    // === COUNTER ANIMATIONS ===
    function animateCounters() {
      const counters = [
        { id: 'counter1', target: 15420 },
        { id: 'counter2', target: 342 },
        { id: 'counter3', target: 28 },
        { id: 'counter4', target: 98 }
      ];
      
      counters.forEach(counter => {
        const element = document.getElementById(counter.id);
        let current = 0;
        const increment = counter.target / 100;
        const timer = setInterval(() => {
          current += increment;
          if (current >= counter.target) {
            element.textContent = counter.target.toLocaleString();
            clearInterval(timer);
          } else {
            element.textContent = Math.floor(current).toLocaleString();
          }
        }, 30);
      });
    }

    // Start counter animation when visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          animateCounters();
          observer.disconnect();
        }
      });
    });

    observer.observe(document.getElementById('counter1'));

    // === CHART INITIALIZATION ===
    const ctx = document.getElementById('datasetsChart').getContext('2d');
    const chartData = {
      labels: ['Total Datasets', 'Processed Today', 'Pending Review', 'AI Summaries', 'Active Users', 'Departments'],
      datasets: [{
        label: 'KMRL Analytics',
        data: [datasets.length, 23, 5, 156, 89, 12],
        backgroundColor: [
          'rgba(0, 102, 204, 0.8)',
          'rgba(0, 212, 255, 0.8)',
          'rgba(255, 107, 53, 0.8)',
          'rgba(139, 92, 246, 0.8)',
          'rgba(34, 197, 94, 0.8)',
          'rgba(248, 113, 113, 0.8)'
        ],
        borderRadius: 8,
        borderWidth: 2,
        borderColor: 'rgba(255, 255, 255, 0.1)'
      }]
    };

    new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 15, 35, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#b3c5ef',
            borderColor: 'rgba(0, 102, 204, 0.5)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#b3c5ef' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          },
          x: {
            ticks: { color: '#b3c5ef' },
            grid: { display: false }
          }
        }
      }
    });

    // === TESTIMONIALS CAROUSEL ===
    const slides = document.querySelectorAll('.testimonial-slide');
    const prevBtn = document.getElementById('prevTestimonial');
    const nextBtn = document.getElementById('nextTestimonial');
    let currentSlide = 0;

    function showSlide(index) {
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
        slide.style.display = i === index ? 'block' : 'none';
      });
    }

    prevBtn.addEventListener('click', () => {
      currentSlide = currentSlide > 0 ? currentSlide - 1 : slides.length - 1;
      showSlide(currentSlide);
    });

    nextBtn.addEventListener('click', () => {
      currentSlide = currentSlide < slides.length - 1 ? currentSlide + 1 : 0;
      showSlide(currentSlide);
    });

    // Auto-advance testimonials
    setInterval(() => {
      currentSlide = currentSlide < slides.length - 1 ? currentSlide + 1 : 0;
      showSlide(currentSlide);
    }, 5000);

    showSlide(currentSlide);

  // === CHATBOT FUNCTIONALITY (OpenAI + fallback) ===
    const chatbotContainer = document.getElementById('chatbot-container');
    const chatbotToggleBtn = document.getElementById('chatbotToggleBtn');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotSettingsBtn = document.getElementById('chatbotSettingsBtn');
    const btnStartChat = document.getElementById('btnStartChat');

    let chatbotOpen = true;
    let storedChatApiKey = localStorage.getItem('kmrlOpenAiKey') || '';
    let typingIndicator = null;

    function toggleChatbot() {
      chatbotOpen = !chatbotOpen;
      chatbotContainer.classList.toggle('minimized', !chatbotOpen);
      chatbotToggleBtn.textContent = chatbotOpen ? 'Hide' : 'Show';
    }

    chatbotToggleBtn.addEventListener('click', toggleChatbot);
    btnStartChat.addEventListener('click', () => {
      chatbotContainer.classList.remove('minimized');
      chatbotOpen = true;
      chatbotToggleBtn.textContent = 'Hide';
      chatbotInput.focus();
    });

    if (chatbotSettingsBtn) {
      chatbotSettingsBtn.addEventListener('click', () => {
        const newKey = prompt(
          'Enter your OpenAI API key (starts with "sk-"). Leave blank to clear the saved key.',
          storedChatApiKey
        );
        if (newKey === null) return;
        storedChatApiKey = newKey.trim();
        if (storedChatApiKey) {
          localStorage.setItem('kmrlOpenAiKey', storedChatApiKey);
          alert('API key saved locally. It will be used for future chat replies.');
        } else {
          localStorage.removeItem('kmrlOpenAiKey');
          alert('Cleared saved OpenAI API key.');
        }
      });
    }

    function addMessage(message, isBot = true) {
      const messageDiv = document.createElement('div');
      messageDiv.style.marginBottom = '1rem';
      messageDiv.style.textAlign = isBot ? 'left' : 'right';

      if (isBot) {
        messageDiv.innerHTML = `<div style="display:inline-block; padding:0.75rem 1rem; border-radius:12px; max-width:80%; background: rgba(0, 102, 204, 0.2); color:#ffffff;"><strong style="color: var(--accent-color);">ü§ñ KMRL AI:</strong><br>${escapeHtml(message)}</div>`;
      } else {
        messageDiv.innerHTML = `<div style="display:inline-block; padding:0.75rem 1rem; border-radius:12px; max-width:80%; background: rgba(255,255,255,0.08); color:#ffffff;"><strong style="color: var(--text-primary);">You:</strong><br>${escapeHtml(message)}</div>`;
      }

      chatbotMessages.appendChild(messageDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function showTypingIndicator() {
      removeTypingIndicator();
      typingIndicator = document.createElement('div');
      typingIndicator.id = 'chatbot-typing';
      typingIndicator.innerHTML =
        `<div style="display:inline-block; padding:0.75rem 1rem; border-radius:12px; background: rgba(0, 102, 204, 0.08); color:#ffffff;">
          <strong style="color: var(--accent-color);">ü§ñ KMRL AI:</strong><br>
          <span class="typing-dots">Thinking<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></span>
        </div>`;
      chatbotMessages.appendChild(typingIndicator);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
      }
      typingIndicator = null;
    }

    // Local fallback responder if API fails
    function getBotResponse(userMessage) {
      const message = (userMessage || '').toLowerCase().trim();
      if (!message) return "Can you rephrase that?";

      const qaPairs = [
        { patterns: ['document overloading', 'document overload'], answer: 'Document overloading means too many redundant or unorganized documents causing delays.' },
        { patterns: ['upload', 'contribute'], answer: "To upload, use the 'Contribute Dataset' section and fill the form." },
        { patterns: ['dataset', 'data'], answer: `We have ${datasets.length} datasets. Use the search bar to find them.` },
      ];

      for (const qa of qaPairs) {
        if (qa.patterns.some(p => message.includes(p))) return qa.answer;
      }

      if (message.includes('help')) return "I can help with search, uploads, and dataset info. Try asking about a dataset name.";
      return "I'm not sure ‚Äî try asking about datasets, uploads, or general system features.";
    }

    async function fetchAssistantResponse(message) {
      const headers = { 'Content-Type': 'application/json' };
      if (storedChatApiKey) {
        headers['X-OpenAI-Key'] = storedChatApiKey;
      }
      const response = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers,
        credentials: 'include',
        body: JSON.stringify({ message })
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.error || 'Assistant is temporarily unavailable.');
      }
      return data.reply || 'I could not craft a response just now.';
    }

    async function sendMessage() {
      const message = chatbotInput.value.trim();
      if (!message) return;

      addMessage(message, false);
      chatbotInput.value = '';

      showTypingIndicator();
      try {
        const reply = await fetchAssistantResponse(message);
        removeTypingIndicator();
        addMessage(reply, true);
      } catch (error) {
        console.error('Chat assistant error:', error);
        removeTypingIndicator();
        const fallback = getBotResponse(message);
        addMessage(`${error.message} Here's a quick tip instead: ${fallback}`, true);
      }
    }

    chatbotSend.addEventListener('click', sendMessage);
    chatbotInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Initial bot message
    setTimeout(() => {
      addMessage("Hello! I'm your KMRL AI assistant. I can help you navigate datasets, upload documents, or answer questions.");
    }, 800);

    // === BUTTON RIPPLE EFFECTS ===
    document.querySelectorAll('.railway-btn, .auth-btn').forEach(button => {
      button.addEventListener('click', function(e) {
        const ripple = document.createElement('span');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.classList.add('ripple');
        
        ripple.style.position = 'absolute';
        ripple.style.borderRadius = '50%';
        ripple.style.background = 'rgba(255, 255, 255, 0.3)';
        ripple.style.transform = 'scale(0)';
        ripple.style.animation = 'ripple 0.6s linear';
        ripple.style.pointerEvents = 'none';
        
        this.appendChild(ripple);
        
        setTimeout(() => {
          ripple.remove();
        }, 600);
      });
    });

    // === SMOOTH SCROLLING ===
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

  
    window.addEventListener('load', () => {
      document.querySelectorAll('.slide-up, .fade-in-delayed').forEach((el, index) => {
        setTimeout(() => {
          el.style.opacity = '1';
          el.style.transform = 'translateY(0)';
        }, index * 100);
      });
      console.log('üöÜ KMRL Enhanced Portal Loaded Successfully!');
    });
  </script>
</body>
</html>
